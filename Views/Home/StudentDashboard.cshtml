@{
    ViewData["Title"] = "Öğrenci Paneli";
    Layout = "_LayoutDashboard";
}

<div class="student-dashboard">
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="welcome-header">
                    <h1 class="dashboard-title">
                        <i class="fas fa-graduation-cap text-success"></i>
                        Hoş Geldiniz, @ViewBag.UserName
                    </h1>
                    <p class="text-muted">Eğitim alanınız - Hedeflerinize ulaşın!</p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Sol Kolon - Eğitim Paketleri -->
            <div class="col-md-8">
                <!-- İstatistik Kartları -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="stat-card modern">
                            <div class="stat-icon-wrapper">
                                <div class="stat-icon bg-gradient-success">
                                    <i class="fas fa-book-open"></i>
                                </div>
                            </div>
                            <div class="stat-content">
                                <h3 class="stat-number" id="activePackages">0</h3>
                                <p class="stat-label">Aktif Paket</p>
                                <div class="stat-trend">
                                    <i class="fas fa-check text-success"></i>
                                    <span class="text-success">Aktif</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card modern">
                            <div class="stat-icon-wrapper">
                                <div class="stat-icon bg-gradient-primary">
                                    <i class="fas fa-video"></i>
                                </div>
                            </div>
                            <div class="stat-content">
                                <h3 class="stat-number" id="totalVideos">0</h3>
                                <p class="stat-label">Toplam Video</p>
                                <div class="stat-trend">
                                    <i class="fas fa-play text-primary"></i>
                                    <span class="text-primary">İzlenebilir</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card modern">
                            <div class="stat-icon-wrapper">
                                <div class="stat-icon bg-gradient-warning">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                            </div>
                            <div class="stat-content">
                                <h3 class="stat-number" id="totalTests">0</h3>
                                <p class="stat-label">Toplam Test</p>
                                <div class="stat-trend">
                                    <i class="fas fa-clipboard-list text-warning"></i>
                                    <span class="text-warning">Çözülebilir</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Eğitim Paketleri -->
                <div class="card shadow-lg border-0 mb-4">
                    <div class="card-header bg-gradient-primary text-white border-0">
                        <h5 class="mb-0">
                            <i class="fas fa-books me-2"></i>
                            Eğitim Paketlerim
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="packageContainer">
                            <div class="text-center p-4">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p class="mt-2">Paketler yükleniyor...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Son Aktiviteler ve İlerleme -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card shadow-lg border-0">
                            <div class="card-header bg-gradient-info text-white border-0">
                                <h6 class="mb-0">
                                    <i class="fas fa-clock text-white me-2"></i>
                                    Son Aktivitelerim
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="activity-list" id="activityList">
                                    <div class="activity-item">
                                        <div class="activity-icon bg-success">
                                            <i class="fas fa-check"></i>
                                        </div>
                                        <div class="activity-content">
                                            <p class="activity-text">LGS Matematik Test 5 tamamlandı</p>
                                            <small class="activity-time">2 saat önce</small>
                                        </div>
                                    </div>
                                    <div class="activity-item">
                                        <div class="activity-icon bg-info">
                                            <i class="fas fa-play"></i>
                                        </div>
                                        <div class="activity-content">
                                            <p class="activity-text">Fonksiyonlar dersi izlendi</p>
                                            <small class="activity-time">5 saat önce</small>
                                        </div>
                                    </div>
                                    <div class="activity-item">
                                        <div class="activity-icon bg-warning">
                                            <i class="fas fa-file-alt"></i>
                                        </div>
                                        <div class="activity-content">
                                            <p class="activity-text">Geometri test sonucu: %85</p>
                                            <small class="activity-time">1 gün önce</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-lg border-0">
                            <div class="card-header bg-gradient-success text-white border-0">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-pie text-white me-2"></i>
                                    Genel İlerleme
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="progress-stats" id="progressStats">
                                    <div class="progress-item">
                                        <span class="progress-label">Matematik</span>
                                        <div class="progress-bar-container">
                                            <div class="progress">
                                                <div class="progress-bar bg-success" style="width: 75%"></div>
                                            </div>
                                            <span class="progress-percent">75%</span>
                                        </div>
                                    </div>
                                    <div class="progress-item">
                                        <span class="progress-label">Türkçe</span>
                                        <div class="progress-bar-container">
                                            <div class="progress">
                                                <div class="progress-bar bg-info" style="width: 60%"></div>
                                            </div>
                                            <span class="progress-percent">60%</span>
                                        </div>
                                    </div>
                                    <div class="progress-item">
                                        <span class="progress-label">Fen Bilimleri</span>
                                        <div class="progress-bar-container">
                                            <div class="progress">
                                                <div class="progress-bar bg-warning" style="width: 45%"></div>
                                            </div>
                                            <span class="progress-percent">45%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sağ Kolon - Öğretmen İletişim -->
            <div class="col-md-4">
                <!-- Öğretmen Profil Kartı -->
                <div class="card shadow-lg border-0 mb-4">
                    <div class="card-header bg-gradient-success text-white border-0">
                        <h5 class="mb-0">
                            <i class="fas fa-user-tie me-2"></i>
                            Matematik Öğretmenim
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="teacher-info" onclick="openTeacherChat()" style="cursor: pointer;">
                            <div class="teacher-avatar">
                                <img src="/img/ogretmen.png" alt="Gurbet CATIN" class="teacher-photo">
                            </div>
                            <div class="teacher-details">
                                <h6 class="teacher-name">Gurbet CATIN</h6>
                                <p class="teacher-title">Matematik Öğretmeni</p>
                                <div class="teacher-status online">
                                    <i class="fas fa-circle"></i> Çevrimiçi
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-comment-dots me-1"></i>
                                    Sohbet için tıklayın
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-light border-0">
                        <button class="btn btn-success btn-sm w-100" onclick="openTeacherChat()">
                            <i class="fas fa-comments me-2"></i>
                            Öğretmenle Sohbet Et
                        </button>
                    </div>
                </div>

                <!-- Mesajlar -->
                <div class="card shadow-lg border-0 mb-4">
                    <div class="card-header bg-gradient-primary text-white border-0">
                        <h5 class="mb-0">
                            <i class="fas fa-comments me-2"></i>
                            Öğretmen Mesajları
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="student-message-list" id="studentMessageList" style="height: 300px; overflow-y: auto;">
                            <div class="text-center p-4">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p class="mt-2">Mesajlar yükleniyor...</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-light border-0">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-sm" onclick="openTeacherChat()">
                                <i class="fas fa-paper-plane me-2"></i>
                                Yeni Mesaj
                            </button>
                            <button class="btn btn-success btn-sm" onclick="loadStudentMessages()">
                                <i class="fas fa-refresh me-2"></i>
                                Mesajları Yenile
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Yaklaşan Etkinlikler -->
                <div class="card shadow-lg border-0">
                    <div class="card-header bg-gradient-info text-white border-0">
                        <h6 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Yaklaşan Etkinlikler
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="event-list">
                            <div class="event-item">
                                <div class="event-date">
                                    <span class="day">15</span>
                                    <span class="month">Şub</span>
                                </div>
                                <div class="event-content">
                                    <h6 class="event-title">LGS Deneme Sınavı</h6>
                                    <p class="event-time">14:00 - 17:00</p>
                                </div>
                            </div>
                            <div class="event-item">
                                <div class="event-date">
                                    <span class="day">20</span>
                                    <span class="month">Şub</span>
                                </div>
                                <div class="event-content">
                                    <h6 class="event-title">Matematik Webinars</h6>
                                    <p class="event-time">19:00 - 20:00</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Öğretmen Sohbet Modal -->
<div class="modal fade" id="teacherChatModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient-success text-white border-0">
                <h5 class="modal-title">
                    <i class="fas fa-chalkboard-teacher me-2"></i>
                    Gurbet CATIN ile Sohbet
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Sohbet Alanı -->
                <div id="teacherChatMessages" style="height: 400px; overflow-y: auto; padding: 15px; background-color: #f8f9fa;">
                    <div class="text-center p-4">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p class="mt-2">Sohbet yükleniyor...</p>
                    </div>
                </div>
                
                <!-- Mesaj Gönderme Alanı -->
                <div class="chat-input-area p-3 border-top bg-white">
                    <div class="row g-2">
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="teacherChatSubject">
                                <option value="Ders Sorusu">Ders Sorusu</option>
                                <option value="Test Hakkında">Test Hakkında</option>
                                <option value="Genel Soru">Genel Soru</option>
                                <option value="Teknik Destek">Teknik Destek</option>
                            </select>
                        </div>
                        <div class="col-md-7">
                            <textarea class="form-control form-control-sm" id="teacherChatContent" rows="2" 
                                    placeholder="Öğretmeninize mesajınızı yazın..." style="resize: none;"></textarea>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-success btn-sm w-100 h-100" onclick="sendTeacherMessage()">
                                <i class="fas fa-paper-plane"></i>
                                <br><small>Gönder</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Paket Aktivasyon Modal -->
<div class="modal fade" id="packageActivationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient-primary text-white border-0">
                <h5 class="modal-title" id="packageActivationTitle">
                    <i class="fas fa-gift me-2"></i>
                    Paket Aktivasyon
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="p-4">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="text-muted">Paket Adı:</p>
                            <h6 id="packageActivationTitle" class="fw-bold"></h6>
                        </div>
                        <div class="col-md-6 text-end">
                            <p class="text-muted">Fiyat:</p>
                            <h6 id="packageActivationPrice" class="fw-bold text-success"></h6>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="text-muted">Açıklama:</p>
                            <p id="packageActivationDescription" class="text-muted"></p>
                        </div>
                        <div class="col-md-6 text-end">
                            <p class="text-muted">Süre:</p>
                            <h6 id="packageActivationDuration" class="fw-bold"></h6>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="text-muted">İçerik:</p>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-video text-primary"></i> <span id="packageActivationVideos"></span> Video</li>
                                <li><i class="fas fa-file-alt text-info"></i> <span id="packageActivationTests"></span> Test</li>
                            </ul>
                        </div>
                    </div>
                    <input type="hidden" id="selectedPackageId" value="">
                    <div class="text-center mt-4">
                        <button class="btn btn-success btn-lg w-100" onclick="activatePackage()">
                            <i class="fas fa-check-circle me-2"></i>Paketi Aktif Et
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Paket Talep Modal -->
<div class="modal fade" id="packageRequestModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient-warning text-white border-0">
                <h5 class="modal-title" id="packageRequestTitle">
                    <i class="fas fa-gift me-2"></i>
                    Paket Talep
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="p-4">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="text-muted">Paket Adı:</p>
                            <h6 id="packageRequestTitle" class="fw-bold"></h6>
                        </div>
                        <div class="col-md-6 text-end">
                            <p class="text-muted">Fiyat:</p>
                            <h6 id="packageRequestPrice" class="fw-bold text-warning"></h6>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="text-muted">Açıklama:</p>
                            <p id="packageRequestDescription" class="text-muted"></p>
                        </div>
                        <div class="col-md-6 text-end">
                            <p class="text-muted">Süre:</p>
                            <h6 id="packageRequestDuration" class="fw-bold"></h6>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="text-muted">İçerik:</p>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-video text-primary"></i> <span id="packageRequestVideos"></span> Video</li>
                                <li><i class="fas fa-file-alt text-info"></i> <span id="packageRequestTests"></span> Test</li>
                            </ul>
                        </div>
                    </div>
                    <input type="hidden" id="requestedPackageId" value="">
                    <div class="text-center mt-4">
                        <button class="btn btn-warning btn-lg w-100" onclick="requestPackage()">
                            <i class="fas fa-paper-plane me-2"></i>Paketi Talep Et
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.student-dashboard {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
    margin: 0;
    width: 100%;
    position: relative;
}

.welcome-header {
    text-align: center;
    margin-bottom: 30px;
    color: white;
}

.dashboard-title {
    color: white;
    font-weight: 600;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.stat-card.modern {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    border: none;
    position: relative;
    overflow: hidden;
}

.stat-card.modern:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0,0,0,0.2);
}

.stat-card.modern::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(45deg, #667eea, #764ba2);
}

.stat-icon-wrapper {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    margin-right: 15px;
}

.bg-gradient-primary {
    background: linear-gradient(45deg, #007bff, #0056b3) !important;
}

.bg-gradient-success {
    background: linear-gradient(45deg, #28a745, #1e7e34) !important;
}

.bg-gradient-info {
    background: linear-gradient(45deg, #17a2b8, #117a8b) !important;
}

.bg-gradient-warning {
    background: linear-gradient(45deg, #ffc107, #e0a800) !important;
}

.stat-content {
    flex-grow: 1;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 5px;
    line-height: 1;
}

.stat-label {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 10px;
    font-weight: 500;
}

.stat-trend {
    display: flex;
    align-items: center;
    font-size: 0.8rem;
    font-weight: 600;
}

.stat-trend i {
    margin-right: 5px;
}

.course-package {
    background: white;
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    cursor: pointer;
    height: 320px;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
}

.course-package::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
}

.course-package.lgs-package::before { background: linear-gradient(45deg, #28a745, #20c997); }
.course-package.tyt-package::before { background: linear-gradient(45deg, #007bff, #0056b3); }
.course-package.ayt-package::before { background: linear-gradient(45deg, #dc3545, #c82333); }

.course-package:hover {
    transform: translateY(-10px);
    box-shadow: 0 15px 40px rgba(0,0,0,0.2);
    cursor: pointer;
}

.course-package:active {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.package-icon {
    font-size: 3rem;
    margin-bottom: 20px;
    color: #6c757d;
}

.lgs-package .package-icon { color: #28a745; }
.tyt-package .package-icon { color: #007bff; }
.ayt-package .package-icon { color: #dc3545; }

.package-info {
    flex-grow: 1;
}

.package-name {
    font-size: 1.25rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 10px;
}

.package-description {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 15px;
}

.package-grade {
    background: #f8f9fa;
    color: #495057;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    display: inline-block;
    margin-bottom: 10px;
}

.package-price {
    background: linear-gradient(45deg, #ff6b6b, #ee5a24);
    color: white;
    padding: 8px 16px;
    border-radius: 25px;
    font-size: 0.9rem;
    font-weight: 700;
    display: inline-block;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
}

.package-stats {
    margin-bottom: 20px;
}

.stat-item {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 8px;
    font-size: 0.85rem;
}

.stat-item i {
    margin-right: 8px;
}

.package-button {
    margin-top: auto;
}

.activity-item {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    border-radius: 10px;
    transition: all 0.3s ease;
}

.activity-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
}

.activity-icon {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    color: white;
    font-size: 0.8rem;
}

.activity-text {
    font-size: 0.9rem;
    color: #2c3e50;
    margin: 0;
    font-weight: 500;
}

.activity-time {
    color: #6c757d;
    font-size: 0.75rem;
}

.progress-item {
    margin-bottom: 15px;
}

.progress-label {
    font-size: 0.9rem;
    color: #2c3e50;
    font-weight: 500;
    margin-bottom: 5px;
    display: block;
}

.progress-bar-container {
    display: flex;
    align-items: center;
    margin-top: 5px;
}

.progress {
    flex-grow: 1;
    margin-right: 10px;
    height: 8px;
    border-radius: 4px;
    background-color: #e9ecef;
}

.progress-bar {
    border-radius: 4px;
    transition: width 0.6s ease;
}

.progress-percent {
    font-size: 0.8rem;
    color: #6c757d;
    font-weight: 600;
    min-width: 35px;
}

.teacher-info {
    display: flex;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

.teacher-info:hover {
    background-color: rgba(40, 167, 69, 0.1);
    border-radius: 10px;
    padding: 10px;
    margin: -10px -10px 15px -10px;
}

.teacher-avatar {
    margin-right: 15px;
}

.teacher-photo {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #28a745;
}

.teacher-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 5px;
}

.teacher-title {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 8px;
}

.teacher-status {
    font-size: 0.8rem;
    font-weight: 500;
}

.teacher-status.online {
    color: #28a745;
}

.teacher-status i {
    font-size: 0.6rem;
    margin-right: 5px;
}

.event-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

.event-item:hover {
    background-color: #f8f9fa;
}

.event-item:last-child {
    border-bottom: none;
}

.event-date {
    text-align: center;
    margin-right: 15px;
    min-width: 50px;
}

.event-date .day {
    display: block;
    font-size: 1.2rem;
    font-weight: 700;
    color: #2c3e50;
}

.event-date .month {
    display: block;
    font-size: 0.8rem;
    color: #6c757d;
    text-transform: uppercase;
}

.event-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 5px;
}

.event-time {
    font-size: 0.8rem;
    color: #6c757d;
    margin: 0;
}

/* Student Chat Message Styles */
.student-chat-sent {
    max-width: 70%;
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
    border-radius: 18px 18px 5px 18px;
    padding: 12px 16px;
    margin-left: auto;
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
}

.student-chat-received {
    max-width: 70%;
    background-color: #e9ecef;
    color: #212529;
    border-radius: 18px 18px 18px 5px;
    padding: 12px 16px;
    margin-right: auto;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Student Message List Styles */
.student-message-item {
    display: flex;
    align-items: flex-start;
    padding: 15px;
    border-bottom: 1px solid #e9ecef;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
}

.student-message-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
}

.student-message-item:last-child {
    border-bottom: none;
}

.student-sent-message {
    background-color: #e8f5e8;
    border-left: 4px solid #28a745;
}

.student-received-message {
    background-color: #e3f2fd;
    border-left: 4px solid #007bff;
}

.student-message-item .message-avatar {
    margin-right: 15px;
    width: 40px;
    text-align: center;
}

.student-message-item .message-avatar i {
    font-size: 1.5em;
}

.student-message-item .message-content {
    flex-grow: 1;
}

.student-message-item .message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.student-message-item .message-sender {
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.9em;
}

.student-message-item .message-time {
    color: #6c757d;
    font-size: 0.8em;
    margin-left: auto;
}

.student-message-item .message-text {
    color: #495057;
    font-size: 0.9em;
    margin: 0;
    line-height: 1.4;
}

.card {
    border-radius: 15px;
    overflow: hidden;
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
}

.form-select, .form-control {
    border-radius: 10px;
    border: 1px solid #e9ecef;
}

.form-select:focus, .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
}

.btn {
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
</style>

<script>
function selectPackage(packageType) {
    // Paket ID'sini al
    const packageId = getPackageId(packageType);
    
    // Önce paket erişimini kontrol et
    fetch(`/Package/CheckPackageAccess?packageId=${packageId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Pakete erişim varsa dersler sayfasına yönlendir
                window.location.href = `/Course/Lessons?packageId=${packageId}`;
            } else {
                // Erişim yoksa paket talep modal'ını aç
                showPackageRequestModal(packageType);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Hata durumunda paket talep modal'ını aç
            showPackageRequestModal(packageType);
        });
}

function showPackageRequestModal(packageType) {
    // Paket bilgilerini al
    fetch(`/Package/GetById?id=${getPackageId(packageType)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const pkg = data.data;
                
                // Modal içeriğini güncelle
                document.getElementById('packageRequestTitle').textContent = `${pkg.name} Paketi`;
                document.getElementById('packageRequestDescription').textContent = pkg.description;
                document.getElementById('packageRequestPrice').textContent = `₺${pkg.price}`;
                document.getElementById('packageRequestDuration').textContent = `${pkg.durationMonths} Ay`;
                document.getElementById('packageRequestVideos').textContent = `${pkg.videoCount} Video`;
                document.getElementById('packageRequestTests').textContent = `${pkg.testCount} Test`;
                
                // Paket ID'sini sakla
                document.getElementById('requestedPackageId').value = pkg.id;
                
                // Modal'ı aç
                new bootstrap.Modal(document.getElementById('packageRequestModal')).show();
            } else {
                alert('Paket bilgileri yüklenirken hata oluştu!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Paket bilgileri yüklenirken hata oluştu!');
        });
}

function getPackageId(packageType) {
    switch(packageType.toLowerCase()) {
        case 'lgs': return 1;
        case 'tyt': return 2;
        case 'ayt': return 3;
        default: return 1;
    }
}

function requestPackage() {
    const packageId = document.getElementById('requestedPackageId').value;
    
    if (!packageId) {
        alert('Paket seçimi hatası!');
        return;
    }
    
    // Paket talebi gönder
    fetch('/Package/RequestPackage', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ packageId: parseInt(packageId) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Paket talebiniz başarıyla gönderildi!');
            
            // Modal'ı kapat
            bootstrap.Modal.getInstance(document.getElementById('packageRequestModal')).hide();
            
            // Paketleri yeniden yükle
            loadPackages();
            loadMyRequests();
        } else {
            alert('Paket talebi başarısız: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Paket talebi sırasında hata oluştu!');
    });
}

function loadMyRequests() {
    fetch('/Package/GetMyRequests')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateRequestStats(data.data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function updateRequestStats(requests) {
    const pendingCount = requests.filter(r => r.status === 'Pending').length;
    const approvedCount = requests.filter(r => r.status === 'Approved').length;
    
    // İstatistikleri güncelle
    document.getElementById('pendingRequests').textContent = pendingCount;
    document.getElementById('approvedRequests').textContent = approvedCount;
}

function openLessons(packageId) {
    // Önce paket erişimini kontrol et
    fetch(`/Package/CheckPackageAccess?packageId=${packageId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Ders sayfasına yönlendir
                window.location.href = `/Course/Lessons?packageId=${packageId}`;
            } else {
                alert('Bu pakete erişiminiz bulunmuyor. Lütfen önce öğretmeninizden onay alın.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Paket erişimi kontrol edilirken hata oluştu!');
        });
}

function sendMessage() {
    const subject = document.getElementById('messageSubject').value;
    const content = document.getElementById('messageContent').value;
    
    if (content.trim() === '') {
        alert('Lütfen mesajınızı yazın!');
        return;
    }
    
    // AJAX ile mesaj gönder
    fetch('/Message/Send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
        },
        body: JSON.stringify({
            subject: subject,
            content: content,
            receiverId: 1 // Öğretmen ID'si
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Mesajınız başarıyla gönderildi!');
            document.getElementById('messageContent').value = '';
        } else {
            alert('Mesaj gönderilirken bir hata oluştu: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Mesaj gönderildi! (Demo modda)');
        document.getElementById('messageContent').value = '';
    });
}

function openTeacherChat() {
    // Modal'ı aç
    new bootstrap.Modal(document.getElementById('teacherChatModal')).show();
    
    // Öğretmenle sohbet mesajlarını yükle
    loadTeacherChatMessages();
}

function loadTeacherChatMessages() {
    const teacherId = 1; // Öğretmen ID'si
    
    fetch(`/Message/GetChatMessages?studentId=${teacherId}`)
        .then(response => response.json())
        .then(data => {
            const chatMessages = document.getElementById('teacherChatMessages');
            
            if (data.success && data.data.length > 0) {
                let messagesHtml = '';
                
                data.data.forEach(message => {
                    const isMyMessage = message.isSentByMe;
                    const messageClass = isMyMessage ? 'student-chat-sent' : 'student-chat-received';
                    const alignClass = isMyMessage ? 'justify-content-end' : 'justify-content-start';
                    
                    messagesHtml += `
                        <div class="d-flex ${alignClass} mb-3">
                            <div class="${messageClass}">
                                <div class="chat-message-content">
                                    <p class="mb-1">${message.content}</p>
                                    <small class="chat-message-time">${message.sentAt}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                chatMessages.innerHTML = messagesHtml;
                
                // En alt mesaja scroll
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else {
                chatMessages.innerHTML = '<div class="text-center p-4"><p class="text-muted">Henüz mesaj bulunmuyor. İlk mesajı gönderin!</p></div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('teacherChatMessages').innerHTML = '<div class="text-center p-4"><p class="text-danger">Sohbet yüklenirken hata oluştu.</p></div>';
        });
}

function sendTeacherMessage() {
    const subject = document.getElementById('teacherChatSubject').value;
    const content = document.getElementById('teacherChatContent').value;
    
    if (!content.trim()) {
        alert('Lütfen mesajınızı yazın!');
        return;
    }
    
    // AJAX ile mesaj gönder
    fetch('/Message/Send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            subject: subject,
            content: content,
            receiverId: 1 // Öğretmen ID'si
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Mesajı temizle
            document.getElementById('teacherChatContent').value = '';
            
            // Sohbeti yeniden yükle
            loadTeacherChatMessages();
        } else {
            alert('Mesaj gönderilirken bir hata oluştu: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Mesaj gönderilirken bir hata oluştu!');
    });
}

// Enter tuşu ile mesaj gönderme (öğrenci tarafı)
document.addEventListener('keydown', function(event) {
    if (event.target.id === 'teacherChatContent' && event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendTeacherMessage();
    }
});

// Öğrenci mesaj listesini yükle
function loadStudentMessages() {
    fetch('/Message/GetMessages')
        .then(response => response.json())
        .then(data => {
            const messageList = document.getElementById('studentMessageList');
            
            if (data.success && data.data.length > 0) {
                let messagesHtml = '';
                
                data.data.forEach(message => {
                    // Mesaj HTML'i oluştur
                    const messageClass = message.isSentByMe ? 'student-sent-message' : 'student-received-message';
                    const messageIcon = message.isSentByMe ? 'fas fa-paper-plane text-success' : 'fas fa-chalkboard-teacher text-primary';
                    
                    messagesHtml += `
                        <div class="student-message-item ${messageClass}" onclick="openTeacherChat()">
                            <div class="message-avatar">
                                <i class="${messageIcon}"></i>
                            </div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-sender">${message.isSentByMe ? 'Siz → Öğretmen' : 'Öğretmen → Siz'}</span>
                                    <span class="message-time">${message.sentAt}</span>
                                    ${!message.isRead && !message.isSentByMe ? '<span class="badge bg-danger ms-2">Yeni</span>' : ''}
                                </div>
                                <p class="message-text">${message.content.substring(0, 100)}${message.content.length > 100 ? '...' : ''}</p>
                            </div>
                        </div>
                    `;
                });
                
                messageList.innerHTML = messagesHtml || '<div class="text-center p-4"><p class="text-muted">Henüz mesaj bulunmuyor.</p></div>';
            } else {
                messageList.innerHTML = '<div class="text-center p-4"><p class="text-muted">Henüz mesaj bulunmuyor.</p></div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('studentMessageList').innerHTML = '<div class="text-center p-4"><p class="text-danger">Mesajlar yüklenirken hata oluştu.</p></div>';
        });
}

// Paketleri yükle
function loadPackages() {
    fetch('/Package/GetAll')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderPackages(data.data);
                updateStats(data.data);
            } else {
                document.getElementById('packageContainer').innerHTML = '<div class="text-center p-4"><p class="text-danger">Paketler yüklenirken hata oluştu.</p></div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('packageContainer').innerHTML = '<div class="text-center p-4"><p class="text-danger">Paketler yüklenirken hata oluştu.</p></div>';
        });
}

function renderPackages(packages) {
    const container = document.getElementById('packageContainer');
    let packagesHtml = '';
    
    packages.forEach(pkg => {
        const packageClass = pkg.name.toLowerCase() + '-package';
        const isActive = pkg.isActive;
        const buttonClass = isActive ? (pkg.name === 'LGS' ? 'btn-success' : 'btn-primary') : 'btn-secondary';
        const buttonText = isActive ? (pkg.name === 'LGS' ? 'Devam Et' : 'Başla') : 'Yakında';
        const buttonIcon = isActive ? 'fas fa-play' : 'fas fa-lock';
        const statusIcon = isActive ? 'fas fa-chart-line text-success' : 'fas fa-lock text-danger';
        const statusText = isActive ? (pkg.name === 'LGS' ? '%78 İlerleme' : '%45 İlerleme') : 'Kilitli';
        
        packagesHtml += `
            <div class="col-md-4 mb-4">
                <div class="course-package ${packageClass}" onclick="selectPackage('${pkg.name.toLowerCase()}')" style="cursor: pointer;">
                    <div class="package-icon">
                        <i class="${pkg.iconClass}"></i>
                    </div>
                    <div class="package-info">
                        <h6 class="package-name">${pkg.name} Paketi</h6>
                        <p class="package-description">${pkg.description}</p>
                        <div class="package-grade">${pkg.grade}</div>
                        <div class="package-price">₺${pkg.price}</div>
                    </div>
                    <div class="package-stats">
                        <div class="stat-item">
                            <i class="fas fa-video text-primary"></i>
                            <span>${pkg.videoCount} Video</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-file-alt text-info"></i>
                            <span>${pkg.testCount} Test</span>
                        </div>
                        <div class="stat-item">
                            <i class="${statusIcon}"></i>
                            <span>${statusText}</span>
                        </div>
                    </div>
                    <div class="package-actions">
                        <button class="btn ${buttonClass} btn-sm" onclick="event.stopPropagation(); selectPackage('${pkg.name.toLowerCase()}')" ${!isActive ? 'disabled' : ''}>
                            <i class="${buttonIcon} me-2"></i>${buttonText}
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="event.stopPropagation(); openLessons(${pkg.id})">
                            <i class="fas fa-graduation-cap me-2"></i>Dersler
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = packagesHtml;
}

function updateStats(packages) {
    let activePackages = 0;
    let totalVideos = 0;
    let totalTests = 0;
    
    packages.forEach(pkg => {
        if (pkg.isActive) {
            activePackages++;
            totalVideos += pkg.videoCount;
            totalTests += pkg.testCount;
        }
    });
    
    document.getElementById('activePackages').textContent = activePackages;
    document.getElementById('totalVideos').textContent = totalVideos;
    document.getElementById('totalTests').textContent = totalTests;
}

// Sayfa yüklendiğinde
document.addEventListener('DOMContentLoaded', function() {
    // Paketleri yükle
    loadPackages();
    
    // Taleplerimi yükle
    loadMyRequests();
    
    // Mesajları yükle
    loadStudentMessages();
    
    // Her 5 saniyede bir mesajları yenile
    setInterval(loadStudentMessages, 5000);
    
    // Her 10 saniyede bir talepleri yenile
    setInterval(loadMyRequests, 10000);
    
    // Eğer öğretmen sohbeti açıksa, onu da yenile
    setInterval(function() {
        if (document.getElementById('teacherChatModal').classList.contains('show')) {
            loadTeacherChatMessages();
        }
    }, 3000);
});
</script>